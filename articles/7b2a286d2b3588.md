---
title: "BitNet-b1.58-2B-4T å‹•ã„ãŸ on Mac"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["llm", "bitnet", "cpu", "metal", "gguf"]
published: true
---

## BitNet-b1.58-2B-4T å‹•ä½œæ‰‹é †

[microsoft/BitNet](https://github.com/microsoft/BitNet) ã®æ‰‹é †ã‚’è¡Œã£ãŸãŒã€cmake ãŒè¿”ã£ã¦æ¥ãªã‹ã£ãŸã®ã§ã€Claude ã«èããªãŒã‚‰å‹•ãã¾ã§ã‚„ã£ã¦ã¿ãŸã€‚

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰å–å¾—
git clone --recursive https://github.com/microsoft/BitNet.git
cd BitNet

# ç’°å¢ƒä½œæˆ
conda create -n bitnet-cpp python=3.9
conda activate bitnet-cpp

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# ãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
huggingface-cli download microsoft/BitNet-b1.58-2B-4T-gguf --local-dir models/BitNet-b1.58-2B-4T

# "DBITNET_ARM_TL1" ã‚’ "ON" ã‹ã‚‰ "OFF" ã«å¤‰æ›´ã™ã‚‹
# ï¼ˆã“ã‚Œã‚’è¡Œã‚ãªã„ã¨æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ãŒè¿”ã£ã¦ã“ãªã„ï¼‰
vim setup_env.py

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
python setup_env.py -md models/BitNet-b1.58-2B-4T -q i2_s

# prompt
python run_inference.py -m models/BitNet-b1.58-2B-4T/ggml-model-i2_s.gguf -p "You are a helpful assistant" -cnv
```

å…¬å¼æ‰‹é †ã®ã¾ã¾ã ã¨ arm64 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ TL1 ã‚«ãƒ¼ãƒãƒ«ãŒä½¿ç”¨ã•ã‚Œã€x86_64 ã§ã¯ TL2 ã‚«ãƒ¼ãƒãƒ«ãŒä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã ã‘ã©ã€TL1 ã‚«ãƒ¼ãƒãƒ«ã ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒçµ‚ã‚ã‚‰ãªã„ã€‚

- TL1 ã‚«ãƒ¼ãƒãƒ«ã§ã¯ã€2 ã¤ã®é‡ã¿ã‚’ 4 ãƒ“ãƒƒãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«åœ§ç¸®
- TL2 ã‚«ãƒ¼ãƒãƒ«ã§ã¯ã€3 ã¤ã®é‡ã¿ã‚’ 5 ãƒ“ãƒƒãƒˆï¼ˆ 1 ãƒ“ãƒƒãƒˆã®ç¬¦å·ã¨ 4 ãƒ“ãƒƒãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ã«åœ§ç¸®

ã‚‰ã—ã„ã€‚

## ç’°å¢ƒ

- Mac Book Pro M1 Max (Memory: 64GB)
- macOS 15.3.1

## è¨ˆç®—æ©Ÿã‚’ä½œã£ã¦ã‚‚ã‚‰ã£ãŸ

`python run_inference.py -m models/BitNet-b1.58-2B-4T/ggml-model-i2_s.gguf -p "Create a minimalist calculator in HTML." -t 8 -c 4096 -n 1024 -temp 0.1`

```html
<!DOCTYPE html>
<html>
<head>
    <title>Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .calculator {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .calculator input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .calculator button {
            padding: 10px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            background-color: #333;
            color: white;
            cursor: pointer;
        }
        .calculator button:hover {
            background-color: #ddd;
        }
        .calculator button:active {
            background-color: #ddd;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <input type="number" id="num1" placeholder="Enter first number">
        <input type="number" id="num2" placeholder="Enter second number">
        <button onclick="add()">Add</button>
        <button onclick="subtract()">Subtract</button>
        <button onclick="multiply()">Multiply</button>
        <button onclick="divide()">Divide</button>
        <div id="result"></div>
    </div>
    <script>
        function add() {
            var num1 = parseFloat(document.getElementById('num1').value);
            var num2 = parseFloat(document.getElementById('num2').value);
            var result = num1 + num2;
            document.getElementById('result').innerHTML = result;
        }
        function subtract() {
            var num1 = parseFloat(document.getElementById('num1').value);
            var num2 = parseFloat(document.getElementById('num2').value);
            var result = num1 - num2;
            document.getElementById('result').innerHTML = result;
        }
        function multiply() {
            var num1 = parseFloat(document.getElementById('num1').value);
            var num2 = parseFloat(document.getElementById('num2').value);
            var result = num1 * num2;
            document.getElementById('result').innerHTML = result;
        }
        function divide() {
            var num1 = parseFloat(document.getElementById('num1').value);
            var num2 = parseFloat(document.getElementById('num2').value);
            if (num2 !== 0) {
                var result = num1 / num2;
                document.getElementById('result').innerHTML = result;
            } else {
                document.getElementById('result').innerHTML = 'Error: Division by zero';
            }
        }
    </script>
</body>
</html>
```

```plain
llama_perf_sampler_print:    sampling time =      82.78 ms /  1032 runs   (    0.08 ms per token, 12467.38 tokens per second)
llama_perf_context_print:        load time =     521.69 ms
llama_perf_context_print: prompt eval time =     292.89 ms /     8 tokens (   36.61 ms per token,    27.31 tokens per second)
llama_perf_context_print:        eval time =   29596.32 ms /  1023 runs   (   28.93 ms per token,    34.57 tokens per second)
llama_perf_context_print:       total time =   30040.13 ms /  1031 tokens
ggml_metal_free: deallocating
```

è¨ˆç®—ã§ãã‚‹ï¼ UI ãƒ‡ã‚¶ã‚¤ãƒ³ã—ã¦ã‚‹ï¼

![calculator.png](/images/7b2a286d2b3588/calculator.png)

## ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã£ã¦ã‚‚ã‚‰ã£ãŸ

`python run_inference.py -m models/BitNet-b1.58-2B-4T/ggml-model-i2_s.gguf -p "Create The Echo Server with Node.js" -t 8 -c 1024 -n 512 -temp 0.8`

```js
const express = require('express');
const app = express();
const port = 3000;
app.use(express.json());

app.get('/', (req, res) => {
  res.send('Hello World');
});

app.get('/echo', (req, res) => {
  const message = req.query.message;
  if (message === '') {
    res.send('This message is empty');
  } else {
    res.send(message);
  }
});

app.listen(port, () => {
  console.log(`Server is running on http://localhost:${port}`);
});
```

```plain
llama_perf_sampler_print:    sampling time =      35.87 ms /   521 runs   (    0.07 ms per token, 14526.70 tokens per second)
llama_perf_context_print:        load time =     525.84 ms
llama_perf_context_print: prompt eval time =     339.55 ms /     9 tokens (   37.73 ms per token,    26.51 tokens per second)
llama_perf_context_print:        eval time =   12836.04 ms /   511 runs   (   25.12 ms per token,    39.81 tokens per second)
llama_perf_context_print:       total time =   13248.82 ms /   520 tokens
```

è¿”ã£ã¦ããŸï¼

```bash
â¯  curl "http://localhost:3000/echo?message=hoge"
hoge
```

## ç‹¬ç™½

ãã†ã§ã™ã€æœ€åˆã‹ã‚‰ 2B ã® LLM ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã•ã›ã‚‹ãªã©æ„šã‹ãªè¡Œç‚ºã§ã—ãŸã€‚ä½•åº¦ã‚‚ä½•åº¦ã‚‚ç”Ÿæˆã‚’ç¹°ã‚Šè¿”ã—ã€æ··æ²Œã®ä¸­ã‹ã‚‰å‹•ãã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç”Ÿã¾ã‚Œã¾ã—ãŸã€‚ç§ãŒä½œã‚Šå‡ºã—ãŸã‚‚ã®ã®ã»ã¨ã‚“ã©ã¯ã€ãŸã ã®ã‚¬ãƒ©ã‚¯ã‚¿ã€ãƒ‡ã‚¸ã‚¿ãƒ«ã®ã‚´ãƒŸã«éããªã‹ã£ãŸã®ã§ã™ã€‚
