---
title: "Open WebUI ã§ MCP ã—ã¦ã¿ãŸï¼ˆã‚‰ã€2 ã¤ã®ä¸éƒ½åˆã«å‡ºä¼šã£ã¦ã©ã†ã«ã‹ã—ã¦ã‚‚ã‚‰ã£ãŸï¼‰"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["llm", "ollama", "openwebui", "mcpo", "MCP"]
published: true
---

## ç’°å¢ƒ

- MacOS 15.3.1
- Ollama version is 0.6.5
    - Ollama ã¯ã€MacOS ä¸Šã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆé Dockerï¼‰
- Docker version 27.5.1
- Open WebUI v0.6.2
    - Docker ã§èµ·å‹•

## 1 ã¤ç›®ã®ä¸éƒ½åˆ

ä¸‹è¨˜ã«æ›¸ã„ãŸæ—¥æœ¬èªï¼ˆãƒãƒ«ãƒãƒã‚¤ãƒˆï¼‰ãŒãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹è¡¨è¨˜ã«ãªã£ã¦ã—ã¾ã†ã‚„ã¤ã€‚ [fetch](https://github.com/modelcontextprotocol/servers/tree/main/src/fetch) ä½¿ã£ã¦ãŸã‚‰æ°—ãŒã¤ã„ãŸã€‚

- [Open WebUI ã§ MCP ã—ã¦ã¿ãŸ - zenn.dev](https://zenn.dev/5203life/articles/bea2eab7b00fd8#fetch-%E3%81%A7%E5%8F%96%E5%BE%97%E3%81%97%E3%81%9F%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%82%92-llm-%E3%81%8C%E8%A7%A3%E9%87%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%EF%BC%9F)

## 2 ã¤ç›®ã®ä¸éƒ½åˆ

MCP Server ã‹ã‚‰è¿”ã•ã‚Œã‚‹ JSON å†…ã«æ”¹è¡Œæ–‡å­—ãŒã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸ `\n` ãŒã‚ã‚‹ã¨ã€`\\n` ã«ãªã£ã¦ Ollama ç­‰ã® API ã«é€ã‚‰ã‚Œã¦ã—ã¾ã†ã€‚ [filesystem](https://github.com/modelcontextprotocol/servers/tree/main/src/filesystem)

filesystem ã® list_directory ãŒä½¿ã‚ã‚Œã‚‹ã¨ã€ä¸‹è¨˜ã®ã‚ˆã†ãª JSON ã‚’ LLM ãŒè§£é‡ˆã§ããšã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãªã‚“ã¦çŸ¥ã‚‰ã‚“ã€ã¨è¨€ã‚ã‚Œã¦ã—ã¾ã£ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã® LLM ã¯ã‚‚ã¡ã‚ã‚“ã€GPT ã«ã‚‚è¨€ã‚ã‚ŒãŸã€‚

æ”¹ä¿®å‰ã¯ã€ã“ã‚Œã‚’ LLM ã«æ¸¡ã—ã¦ã„ãŸã€‚

```json
[
  "[FILE] abc\\n[FILE] xyz"
]
```

ã“ã†ãªã‚‹ã‚ˆã†ã«æ”¹ä¿®ã—ãŸã‚‰ã€LLM ãŒè§£é‡ˆã—ã¦ãã‚ŒãŸã€‚

```json
[
  "[FILE] abc\n[FILE] xyz"
]
```

æ”¹ä¿®å†…å®¹ã¯

backend/open_webui/utils/json_encoder.py (æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«)

```python
import json

class PreserveControlCharsEncoder(json.JSONEncoder):
    def encode(self, obj):
        result = super().encode(obj)
        result = result.replace('\\n', '\n')
        result = result.replace('\\r', '\r')
        result = result.replace('\\t', '\t')
        return result

def json_dumps_preserve_control_chars(obj, **kwargs):
    return json.dumps(obj, cls=PreserveControlCharsEncoder, **kwargs)

tool_result = json_dumps_preserve_control_chars(tool_result, indent=2, ensure_ascii=False)
```

[backend/open_webui/utils/middleware.py](https://github.com/open-webui/open-webui/blob/63533c9e3ab41edd7bd4124ef94f6b6dc09aa175/backend/open_webui/utils/middleware.py#L233) (æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«)

```diff
  import time
  import logging
  import sys
  import os
  import base64
+ from open_webui.utils.json_encoder import json_dumps_preserve_control_chars
```

```diff
                  if isinstance(tool_result, dict) or isinstance(tool_result, list):
-                     tool_result = json.dumps(tool_result, indent=2)
+                     tool_result = json_dumps_preserve_control_chars(tool_result, indent=2, ensure_ascii=False)
```

## ä¸å…·åˆãªã®ã‹ï¼Ÿ

ä¸éƒ½åˆã§ã¯ã‚ã‚‹ãŒã€ä¸å…·åˆã‹ã©ã†ã‹ã®åˆ¤æ–­ãŒã§ããªã‹ã£ãŸã®ã§ã€ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã«æŠ•ã’ã¦ã¿ãŸã€‚

mcpo ã®æ”¹ä¿®ã ã£ãŸã‚‰ã€Issue ãªã‚Š PR ãªã‚ŠæŠ•ã’ãŸã‘ã©ã­ã€‚

- [Escaping of multibyte characters and newlines by json.dumps() when using MCP (mcpo) Â· open-webui/open-webui Â· Discussion #12764 - github.com](https://github.com/open-webui/open-webui/discussions/12764) 

## ã¡ãªã¿ã«

ã‚ãŸã—ã¯ Python ã‚’ã»ã¼æ›¸ã„ãŸã“ã¨ãŒãªã„ã€‚ï¼ˆHello world ã«æ¯›ãŒç”ŸãˆãŸãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚„ã€Python ã® OSS ã§ä¸­ã‚’è¦—ããã‚‰ã„ï¼‰

ã„ã¾ã€ Cursor ã‚„ Windsurfã€ãã®ä»–è«¸ã€…ã‚’ä½¿ã£ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã—ã¦ã„ã‚‹ãŒã€ Windsurf ãŒã‚ã£ã¨ã„ã†é–“ã«ä¸éƒ½åˆã‚’è§£æ±ºã—ã¦ãã‚ŒãŸã€‚ï¼ˆã“ã®ä»¶ã«é–¢ã—ã¦ã¯ Cursor ã¯ãƒ€ãƒ¡ã ã£ãŸï¼‰

ä»¥ä¸Š
